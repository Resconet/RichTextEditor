<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<title></title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<meta http-equiv='X-UA-Compatible' content='IE=edge' />
	<meta name='viewport' content='initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no'>
	<script src="js/tinymce/tinymce.min.js"></script>
	<script src="../JSBridge.js"></script>
	<script>

		/** SIMPLE TOOLBAR FUNCTIONALITY */
		tinymce.init({
			selector: 'textarea',
			plugins: [
				'advlist autolink lists link image charmap preview hr anchor pagebreak',
				'textcolor colorpicker'
				//'searchreplace visualblocks visualchars code fullscreen',
				//'insertdatetime media nonbreaking save table contextmenu directionality',
				//'emoticons template paste textcolor colorpicker textpattern imagetools codesample toc help'
			],
			toolbar1: 'undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent',
			toolbar2: '',//'visualblocks preview media | forecolor backcolor emoticons | codesample help',
			//menubar: 'file edit insert format table tools',
			menubar: 'edit table',
			removed_menuitems: "fullscreen",
			statusbar: false, // If we want wordcount in the footer, comment this and add wordcount to plugins.
			setup: function (editor) {
				editor.on('init', function (e) {
					editor.execCommand('mceFullScreen');
					loadData(editor);
				});
			},
		});

		/** FULL TOOLBAR FUNCTIONALITY */
		/*
		tinymce.init({
			selector: 'textarea',
			plugins: [
				'advlist autolink lists link image charmap preview hr anchor pagebreak',
				'searchreplace visualblocks visualchars code fullscreen',
				'insertdatetime media nonbreaking save table contextmenu directionality',
				'emoticons template paste textcolor colorpicker textpattern imagetools codesample toc help'
			],
			toolbar1: 'undo redo | insert | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image',
			toolbar2: 'visualblocks preview media | forecolor backcolor emoticons | codesample help',
			//menubar: 'file edit insert format table tools',
			menubar: 'edit insert format table',
			removed_menuitems: "fullscreen",
			statusbar: false, // If we want wordcount in the footer, comment this and add wordcount to plugins.
			setup: function (editor) {
				editor.on('init', function (e) {
					editor.execCommand('mceFullScreen');
					loadData(editor);
				});
			}
		});
		*/
	</script>
	<style>

		.mce-widget * {
			font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,"Helvetica Neue",sans-serif;
		}

		.mce-container.mce-tinymce {
			border: 0 !important;
		}

		.mce-branding-powered-by {
			display: none;
		}
	</style>
</head>
<body>
	<textarea></textarea>
	<script>
		// Whether to automatically update the html editor when the entity property changes.
		var handleOnChange = true;
		// Whether to update the entity property when the content of the html editor is changed.
		var updateEntityOnChange = true;

		function loadData(editor) {
			var getUrlParams = function () {
				var match,
					pl = /\+/g,  // Regex for replacing addition symbol with a space
					search = /([^&=]+)=?([^&]*)/g,
					decode = function (s) { return decodeURIComponent(s.replace(pl, " ")); },
					query = window.location.search.substring(1);

				var urlParams = {};
				while (match = search.exec(query))
					urlParams[decode(match[1])] = decode(match[2]);
				return urlParams;
			}
			// Get the name of the entity field from param: index.html?field=description
			var p = getUrlParams();
			var field = p['field'];

			// Saves the content of the editot back into the entity property.
			var saveEditorContent = function (entityForm) {
				var entity = entityForm.entity;
				entity.properties[field] = editor.getContent();
				return true;
			};

			// Method called when the editor content is changed. After editor loses focus.
			// Marks the controller dirty and optionally saves the content back to the entity.
			var onEditorChanged = function () {
				MobileCRM.bridge.invokeMethodAsync("WebController", "set_IsDirty", [true]);

				if (updateEntityOnChange) {
					MobileCRM.UI.EntityForm.requestObject(saveEditorContent,
						function (err) { sayError(err); }
					);
				}
			};

			var setReadOnlyFromMetadata = function (entityName) {
				MobileCRM.Metadata.requestObject(metaData => {
					var entity = metaData.getEntity(entityName);
					if (entity) {
						var prop = entity.getProperty(field);
						if (!prop || ((prop.permission & 2) == 0)) // validate bit mask of permission on field level.
							editor.setMode('readonly');
					}
				}, MobileCRM.bridge.alert, null);
			}

			// Loads the editor content from entity property.
			// Starts watching for content changes.
			// If the form is non-editable the editor is made readonly. No support for field level permisions yet.
			var loadEditorContent = function (entityForm) {

				editor.off('Change'); // Disable change event
				editor.setContent(text || "");
				if (entityForm.canEdit) {
					editor.on('Change', onEditorChanged);
				} else {
					editor.setMode('readonly');
				}

				var text = entityForm.entity.properties[field];
				setReadOnlyFromMetadata(entityForm.entity.entityName);
			};

			// Registers the entity property change event.
			var registerOnChange = function () {
				// If available, use the 11.2 itemChange event.
				if (MobileCRM.UI.EntityForm.onItemChange) {
					MobileCRM.UI.EntityForm.onItemChange(field, function (entityForm) {
						loadEditorContent(entityForm);
					}, true, null);
				}
				else {
					MobileCRM.UI.EntityForm.onChange(function (entityForm) {
						if (entityForm.context.changedItem === field) {
							loadEditorContent(entityForm);
						}
					}, true, null);
				}
			};

			// Gets the parent form object and loads the editor.
			MobileCRM.UI.EntityForm.requestObject(
				function (entityForm) {
					/// <param name="entityForm" type="MobileCRM.UI.EntityForm"/>
					// Get the MobileCRM.DynamicEntity which is being edited on this form
					loadEditorContent(entityForm);

					if (handleOnChange)
						registerOnChange();

					return false;
				},
				function (err) {
					MobileCRM.bridge.alert("An error occurred: " + err);
				},
				null
			);

			// Registers for the parent form save event.
			MobileCRM.UI.EntityForm.onSave(
				saveEditorContent,
				true,
				null
			);
		}
	</script>
</body>
</html>
